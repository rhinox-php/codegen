#!/usr/bin/env php
<?php
if (!class_exists('Rhino\Codegen\Codegen')) {
    if (is_file(__DIR__ . '/../vendor/autoload.php')) {
        require __DIR__ . '/../vendor/autoload.php';
    } elseif (is_file(__DIR__ . '/../../../autoload.php')) {
        require __DIR__ . '/../../../autoload.php';
    } else {
        throw new Exception('Cannot file autoloader, tried ' . __DIR__ . '/../vendor/autoload.php and ' . __DIR__ . '/../../../autoload.php');
    }
}

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;

function getCodegen(InputInterface $input, OutputInterface $output) {
    $schema = $input->getOption('schema');
    switch (pathinfo($schema, PATHINFO_EXTENSION)) {
        case 'php': {
            if (!is_file($schema)) {
                throw new \Exception('Could not find codegen schema file: ' . $schema);
            }
            $codegen = require $schema;
            break;
        }
        case 'xml': {
            $xmlParser = new \Rhino\Codegen\XmlParser($schema);
            $codegen = $xmlParser->parse();
            break;
        }
    }
    $codegen->setDryRun(!$input->getOption('execute'));
    return $codegen;
}

$application = new Application();
$application->add(new class() extends Command {
    protected function configure() {
        $this->setName('gen')
            ->setDescription('Generate code')
            ->addOption('execute', 'x', InputOption::VALUE_NONE, 'Execute code generation (otherwise dry run).')
            ->addOption('schema', 's', InputOption::VALUE_REQUIRED, 'Codegen schema file to load.', 'codegen.php');
    }

    protected function execute(InputInterface $input, OutputInterface $output) {
        getCodegen($input, $output)->generate();
    }
});
$application->add(new class() extends Command {
    protected function configure() {
        $this->setName('migrate')
            ->setDescription('Generate migrations')
            ->addOption('execute', 'x', InputOption::VALUE_NONE, 'Execute code generation (otherwise dry run).')
            ->addOption('schema', 's', InputOption::VALUE_REQUIRED, 'Codegen schema file to load.', 'codegen.php')
            ->addArgument('outputPath', InputArgument::REQUIRED, 'Path to output generated files to.');
    }

    protected function execute(InputInterface $input, OutputInterface $output) {
        $schema = $input->getArgument('schema');
        $xmlParser = new \Rhino\Codegen\XmlParser($schema);
        $codegen = $xmlParser->parse();
        $codegen->setDryRun(!$input->getOption('execute'));
        $codegen->migrate($input->getArgument('outputPath'));
    }
});
$application->add(new class() extends Command {
    protected function configure() {
        $this->setName('db:reset')
            ->setDescription('Reset table')
            ->addOption('execute', 'x', InputOption::VALUE_NONE, 'Execute code generation (otherwise dry run).')
            ->addOption('schema', 's', InputOption::VALUE_REQUIRED, 'Codegen schema file to load.', 'codegen.php')
            ->addArgument('entity', InputArgument::OPTIONAL, 'Entity type to reset.');
    }

    protected function execute(InputInterface $input, OutputInterface $output) {
        getCodegen($input, $output)->reset($input->getArgument('entity'));
    }
});
$application->run();
